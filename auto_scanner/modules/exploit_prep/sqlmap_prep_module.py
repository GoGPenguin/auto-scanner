#!/usr/bin/env python3
# -*- coding: utf-8 -*-

# import os  <-- ĐÃ XÓA (vì thừa)
import re
from ..base_module import BaseModule

class SQLMapPrepModule(BaseModule):

    name = "SQLMap Prep"

    def pre_run_check(self, target, profile):
        return "Nikto" in target.results or "Uniscan" in target.results

    def run(self, target, profile, timestamp, tool_args=None, default_timeout=None):
        """
        (NÂNG CẤP v1.5) Regex tốt hơn để tìm tham số.
        """
        print(f"[INFO] Bắt đầu tạo file chuẩn bị cho SQLMap trên: {target.target_str}...")
        
        potential_sqli_urls = []
        seen_urls = set()
        
        # (NÂNG CẤP v1.5) Regex đơn giản và tham lam (greedy) hơn
        param_regex = re.compile(r'(https?://[^\s\"\'<>]+?\?[\w\d]+=[\w\d]*?)')

        # 1. Tìm trong kết quả Nikto
        # current_host = ... <-- ĐÃ XÓA (vì không được dùng)
        
        for line in target.results.get("Nikto", []):
            if "?" in line and "=" in line:
                matches = param_regex.findall(line)
                for url in matches:
                    if url not in seen_urls:
                        potential_sqli_urls.append(url)
                        seen_urls.add(url)
        
        # (Bạn có thể thêm logic tương tự để đọc target.results.get("Uniscan", []))
        
        if not potential_sqli_urls:
            print(f"[INFO] Không tìm thấy URL nghi ngờ SQLi rõ ràng cho {target.target_str}.")
            target.add_result(self.name, [f"Không tìm thấy URL nghi ngờ SQLi rõ ràng."])
            return
            
        # 2. Ghi ra file
        output_file = f"{target.project_dir}/SUGGESTED_SQLMAP_COMMANDS.txt"
        findings = [
            f"Đã phát hiện {len(potential_sqli_urls)} URL nghi ngờ SQL Injection.",
            f"Các lệnh SQLMap đề xuất đã được lưu tại: {output_file}"
        ]
        
        try:
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(f"# Các lệnh SQLMap được đề xuất tự động cho: {target.target_str}\n")
                f.write("# (Hãy kiểm tra lại các lệnh này trước khi chạy!)\n\n")
                for url in potential_sqli_urls:
                    f.write(f'sqlmap -u "{url}" --dbs --batch --random-agent\n')
            
            target.add_result(self.name, findings)
            
        except Exception as e:
            target.add_result(self.name, [f"[LỖI] Không thể ghi file SQLMap prep: {e}"])