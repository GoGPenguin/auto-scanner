#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import re
from ..base_module import BaseModule

class SQLMapPrepModule(BaseModule):
    name = "SQLMap Prep"
    tag = "exploit_prep"
    def pre_run_check(self, target, profile): return "Nikto" in target.results
    def run(self, target, profile, timestamp, tool_args=None, default_timeout=None):
        sqli_urls = []
        regex = re.compile(r'(https?://[^\s\"\'<>]+?\?[\w\d]+=[\w\d]*?)')
        for line in target.results.get("Nikto", []):
            if "?" in line:
                found = regex.findall(line)
                for u in found: sqli_urls.append(u)
        
        sqli_urls = list(set(sqli_urls))
        if sqli_urls:
            outfile = f"{target.project_dir}/SQLMAP_COMMANDS.txt"
            with open(outfile, 'w') as f:
                for u in sqli_urls: f.write(f"sqlmap -u '{u}' --batch\n")
            target.add_result(self.name, [f"Found {len(sqli_urls)} potential SQLi URLs.", f"Saved to {outfile}"])
            target.add_json_result({"tool": "SQLMapPrep", "count": len(sqli_urls), "file": outfile})
        else:
            target.add_result(self.name, ["No obvious SQLi parameters found."])