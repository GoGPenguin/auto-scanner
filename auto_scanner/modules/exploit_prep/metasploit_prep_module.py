#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import subprocess
import json
import re
import shutil # Import shutil để dùng which
from ..base_module import BaseModule

class MetasploitPrepModule(BaseModule):

    name = "Metasploit Prep"
    tag = "exploit_prep"

    def pre_run_check(self, target, profile):
        """
        Chỉ chạy nếu có kết quả Nmap và lệnh searchsploit tồn tại.
        """
        if "Nmap" not in target.results:
            return False
        
        # Kiểm tra searchsploit một lần duy nhất và lưu lại
        if not hasattr(self, 'searchsploit_path'):
            self.searchsploit_path = shutil.which('searchsploit')
            if not self.searchsploit_path:
                print("[WARN] Không tìm thấy 'searchsploit'. Module Metasploit Prep sẽ bị bỏ qua.")
                print("       (Gợi ý: sudo apt install exploitdb)")
                return False
        return True

    def run(self, target, profile, timestamp):
        """
        Đọc kết quả Nmap, dùng searchsploit để tìm module MSF.
        """
        print(f"[INFO] Bắt đầu tìm module Metasploit cho: {target.target_str}...")
        
        # Regex để trích xuất tên dịch vụ và phiên bản
        # Ví dụ: [+] Cổng 22/tcp (Mở) - Dịch vụ: ssh OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.13
        service_regex = re.compile(r'Dịch vụ: \w+ ([\w\s\d\.-]+)')
        
        exploitable_services = []
        
        for line in target.results.get("Nmap", []):
            match = service_regex.search(line)
            if match:
                service_string = match.group(1).strip() # Ví dụ: "OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.13"
                
                # Rút gọn chuỗi tìm kiếm (ví dụ: "OpenSSH 6.6.1")
                search_term = " ".join(service_string.split(' ')[:2])
                
                print(f"[INFO] Đang tìm exploit cho: {search_term}...")
                
                # 2. Chạy searchsploit
                # -j : JSON output
                # --type metasploit : Chỉ tìm các module MSF
                command = [self.searchsploit_path, '-j', '--type', 'metasploit', search_term]
                
                try:
                    result = subprocess.run(command, check=True, capture_output=True, text=True, timeout=60)
                    msf_results = json.loads(result.stdout)
                    
                    if msf_results.get("RESULTS", []):
                        exploitable_services.append({
                            "service": service_string,
                            "search_term": search_term,
                            "results": msf_results["RESULTS"]
                        })
                except Exception as e:
                    print(f"[WARN] Searchsploit thất bại cho '{search_term}'. Lỗi: {e}")

        if not exploitable_services:
            print(f"[INFO] Không tìm thấy module Metasploit nào cho {target.target_str}.")
            target.add_result(self.name, [f"Không tìm thấy module Metasploit (qua Exploit-DB) nào."])
            return

        # 3. Ghi ra file
        output_file = f"{target.project_dir}/SUGGESTED_METASPLOIT_MODULES.txt"
        findings = [
            f"Đã phát hiện {len(exploitable_services)} dịch vụ có thể có module Metasploit.",
            f"Các gợi ý đã được lưu tại: {output_file}"
        ]
        
        try:
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(f"# Các module Metasploit được đề xuất tự động cho: {target.target_str}\n")
                f.write(f"# (Dựa trên Exploit-DB. Hãy kiểm tra lại trước khi chạy!)\n\n")
                
                for service in exploitable_services:
                    f.write("="*30 + "\n")
                    f.write(f"Dịch vụ tìm thấy: {service['service']}\n")
                    f.write(f"(Tìm kiếm với từ khóa: '{service['search_term']}')\n")
                    f.write("="*30 + "\n")
                    
                    for exploit in service['results']:
                        f.write(f"  Tên Exploit: {exploit.get('Title')}\n")
                        f.write(f"  Đường dẫn: {exploit.get('Path')}\n")
                        # Trích xuất tên module .rb (ví dụ: exploits/unix/ftp/vsftpd_234_backdoor.rb)
                        # Bỏ 'exploits/' và '.rb'
                        module_name = exploit.get('Path').replace('exploits/', '', 1).replace('.rb', '')
                        f.write(f"  => Gợi ý lệnh MSF: use {module_name}\n\n")

            target.add_result(self.name, findings)
            
        except Exception as e:
            target.add_result(self.name, [f"[LỖI] Không thể ghi file Metasploit prep: {e}"])