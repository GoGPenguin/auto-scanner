#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import subprocess
import shutil
import re
import json
from ..base_module import BaseModule

class MetasploitPrepModule(BaseModule):
    name = "Metasploit Prep"
    tag = "exploit_prep"
    
    def pre_run_check(self, target, profile):
        self.sp_path = shutil.which('searchsploit')
        return "Nmap" in target.results and self.sp_path

    def run(self, target, profile, timestamp, tool_args=None, default_timeout=None):
        regex = re.compile(r'Service: \w+ ([\w\s\d\.-]+)') # Regex đơn giản hơn
        # Regex cũ: Dịch vụ: ... (nếu Nmap trả tiếng Việt)
        # Nmap XML parse của ta trả về: "Port 22: ssh OpenSSH 8.2..."
        # Nên ta dùng regex đơn giản tìm version
        
        exploits = []
        for line in target.results.get("Nmap", []):
            # line format: "Port 80: http Apache 2.4.41"
            parts = line.split(':')
            if len(parts) > 1:
                svc_info = parts[1].strip() # "http Apache 2.4.41"
                search_term = " ".join(svc_info.split(' ')[:2]) # "http Apache"
                
                cmd = [self.sp_path, '-j', '--type', 'metasploit', search_term]
                try:
                    res = subprocess.run(cmd, check=False, capture_output=True, text=True)
                    if res.returncode == 0 and res.stdout:
                        try:
                            data = json.loads(res.stdout)
                            if data.get("RESULTS"):
                                exploits.append({"term": search_term, "results": data["RESULTS"]})
                        except: pass
                except: pass

        if exploits:
            outfile = f"{target.project_dir}/MSF_SUGGESTIONS.txt"
            with open(outfile, 'w') as f:
                for item in exploits:
                    f.write(f"--- {item['term']} ---\n")
                    for r in item['results']:
                        f.write(f"Title: {r['Title']}\nPath: {r['Path']}\n\n")
            target.add_result(self.name, [f"Found exploits for {len(exploits)} services.", f"Saved to {outfile}"])
            target.add_json_result({"tool": "MetasploitPrep", "count": len(exploits)})
        else:
            target.add_result(self.name, ["No Metasploit modules found."])