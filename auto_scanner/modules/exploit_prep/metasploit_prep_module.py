#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import subprocess
import os
import json
import re
import shutil 
from ..base_module import BaseModule

class MetasploitPrepModule(BaseModule):

    name = "Metasploit Prep"

    def pre_run_check(self, target, profile):
        if "Nmap" not in target.results:
            return False
        if not hasattr(self, 'searchsploit_path'):
            self.searchsploit_path = shutil.which('searchsploit')
            if not self.searchsploit_path:
                print("[WARN] Không tìm thấy 'searchsploit'.")
                return False
        return True

    def run(self, target, profile, timestamp, tool_args=None, default_timeout=None):
        print(f"[INFO] Bắt đầu tìm module Metasploit cho: {target.target_str}...")
        
        service_regex = re.compile(r'Dịch vụ: \w+ ([\w\s\d\.-]+)')
        exploitable_services = []
        
        # Lấy danh sách kết quả từ Nmap
        nmap_results = target.results.get("Nmap", [])
        
        for line in nmap_results:
            match = service_regex.search(line)
            if match:
                service_string = match.group(1).strip()
                # Rút gọn từ khóa tìm kiếm (lấy 2 từ đầu tiên)
                search_term = " ".join(service_string.split(' ')[:2])
                
                print(f"[INFO] Đang tìm exploit cho: {search_term}...")
                
                # Cấu trúc lệnh
                command = [self.searchsploit_path, '-j', '--type', 'metasploit', search_term]
                
                try:
                    # (FIX) Đổi check=True thành check=False để không crash khi không tìm thấy
                    result = subprocess.run(command, check=False, capture_output=True, text=True, timeout=60)
                    
                    # Nếu chạy thành công (Exit code 0) VÀ có nội dung
                    if result.returncode == 0 and result.stdout:
                        try:
                            msf_results = json.loads(result.stdout)
                            if msf_results.get("RESULTS", []):
                                exploitable_services.append({
                                    "service": service_string,
                                    "search_term": search_term,
                                    "results": msf_results["RESULTS"]
                                })
                        except json.JSONDecodeError:
                            pass # Bỏ qua nếu output không phải JSON chuẩn
                    
                    # Nếu exit code != 0 (thường là không tìm thấy), ta chỉ cần bỏ qua, không báo lỗi.
                    
                except Exception as e:
                    # Chỉ báo lỗi nếu thực sự có lỗi hệ thống (như timeout)
                    print(f"[WARN] Lỗi khi chạy Searchsploit cho '{search_term}': {e}")

        if not exploitable_services:
            print(f"[INFO] Không tìm thấy module Metasploit nào (hoặc version quá mới/lạ).")
            # Vẫn ghi nhận là module đã chạy xong
            target.add_result(self.name, [f"Không tìm thấy module Metasploit phù hợp."])
            return

        # Ghi kết quả ra file
        output_file = f"{target.project_dir}/SUGGESTED_METASPLOIT_MODULES.txt"
        findings = [
            f"Đã phát hiện {len(exploitable_services)} dịch vụ có thể có module Metasploit.",
            f"Các gợi ý đã được lưu tại: {output_file}"
        ]
        
        try:
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(f"# Các module Metasploit được đề xuất tự động cho: {target.target_str}\n")
                f.write(f"# (Dựa trên Exploit-DB. Hãy kiểm tra lại trước khi chạy!)\n\n")
                
                for service in exploitable_services:
                    f.write("="*30 + "\n")
                    f.write(f"Dịch vụ: {service['service']}\n")
                    f.write(f"(Từ khóa tìm kiếm: '{service['search_term']}')\n")
                    f.write("="*30 + "\n")
                    
                    for exploit in service['results']:
                        # Trích xuất tên module cho đẹp
                        path = exploit.get('Path', '')
                        title = exploit.get('Title', 'Unknown')
                        
                        # Logic làm sạch đường dẫn để lấy tên module MSF
                        if 'metasploit' in path:
                            # Thường path có dạng: exploits/linux/http/module_name.rb
                            # Ta cần biến nó thành: linux/http/module_name
                            module_name = path.replace('exploits/', '', 1).replace('.rb', '')
                            f.write(f"  Tên: {title}\n")
                            f.write(f"  => Lệnh MSF: use {module_name}\n\n")
                        else:
                            f.write(f"  Tên: {title}\n")
                            f.write(f"  Path: {path}\n\n")

            target.add_result(self.name, findings)
            
        except Exception as e:
            target.add_result(self.name, [f"[LỖI] Không thể ghi file Metasploit prep: {e}"])