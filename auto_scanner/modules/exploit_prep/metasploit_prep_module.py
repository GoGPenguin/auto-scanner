#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import subprocess
import os
import json
import re
import shutil 
from ..base_module import BaseModule

class MetasploitPrepModule(BaseModule):

    name = "Metasploit Prep"

    def pre_run_check(self, target, profile):
        if "Nmap" not in target.results:
            return False
        if not hasattr(self, 'searchsploit_path'):
            self.searchsploit_path = shutil.which('searchsploit')
            if not self.searchsploit_path:
                print("[WARN] Không tìm thấy 'searchsploit'.")
                return False
        return True

    # (ĐÃ SỬA)
    def run(self, target, profile, timestamp, tool_args=None, default_timeout=None):
        print(f"[INFO] Bắt đầu tìm module Metasploit cho: {target.target_str}...")
        
        service_regex = re.compile(r'Dịch vụ: \w+ ([\w\s\d\.-]+)')
        exploitable_services = []
        
        for line in target.results.get("Nmap", []):
            match = service_regex.search(line)
            if match:
                service_string = match.group(1).strip()
                search_term = " ".join(service_string.split(' ')[:2])
                print(f"[INFO] Đang tìm exploit cho: {search_term}...")
                
                command = [self.searchsploit_path, '-j', '--type', 'metasploit', search_term]
                try:
                    result = subprocess.run(command, check=True, capture_output=True, text=True, timeout=60)
                    msf_results = json.loads(result.stdout)
                    if msf_results.get("RESULTS", []):
                        exploitable_services.append({
                            "service": service_string,
                            "search_term": search_term,
                            "results": msf_results["RESULTS"]
                        })
                except Exception as e:
                    print(f"[WARN] Searchsploit thất bại cho '{search_term}'. Lỗi: {e}")

        if not exploitable_services:
            print(f"[INFO] Không tìm thấy module Metasploit nào.")
            target.add_result(self.name, [f"Không tìm thấy module Metasploit."])
            return

        output_file = f"{target.project_dir}/SUGGESTED_METASPLOIT_MODULES.txt"
        findings = [
            f"Đã phát hiện {len(exploitable_services)} dịch vụ có thể có module Metasploit.",
            f"Các gợi ý đã được lưu tại: {output_file}"
        ]
        try:
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(f"# Các module Metasploit được đề xuất tự động cho: {target.target_str}\n\n")
                for service in exploitable_services:
                    f.write("="*30 + "\n")
                    f.write(f"Dịch vụ: {service['service']}\n")
                    f.write("="*30 + "\n")
                    for exploit in service['results']:
                        module_name = exploit.get('Path').replace('exploits/', '', 1).replace('.rb', '')
                        f.write(f"  => Gợi ý lệnh MSF: use {module_name}\n\n")
            target.add_result(self.name, findings)
        except Exception as e:
            target.add_result(self.name, [f"[LỖI] Không thể ghi file Metasploit prep: {e}"])